<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin - Users</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#f4f6f9;padding:20px}
    .card{max-width:1100px;margin:0 auto;padding:18px;background:#fff;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,.06)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #eee;text-align:left}
    th{background:#222;color:#fff;position:sticky;top:0}
    .tools{display:flex;gap:8px;margin-bottom:12px}
    button{padding:8px 12px;border-radius:6px;border:0;background:#2d9cdb;color:#fff;cursor:pointer}
    .status{margin-top:8px;color:#333}
  </style>
</head>
<body>
  <div class="card">
    <h2>Admin - Registered Users</h2>
    <div class="tools">
      <button id="refreshBtn">Refresh</button>
      <button id="exportBtn">Export CSV</button>
    </div>
    <div class="status" id="status"></div>
    <div id="tableWrap"></div>
  </div>

  <script>
    const SUPABASE_URL = 'https://ccmsjcnuyrngqxwrswfe.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNjbXNqY251eXJuZ3F4d3Jzd2ZlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE2MjU2MjgsImV4cCI6MjA2NzIwMTYyOH0.dkjCo2bgDMf923VKESkyMLsULo7IhmsYb6r-4Dn6SRY';

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const statusEl = document.getElementById('status');
    const tableWrap = document.getElementById('tableWrap');

    function setStatus(msg) {
      statusEl.textContent = msg;
    }

    async function loadUsers() {
      setStatus('Loading...');
      const { data, error } = await supabase
        .from('users')
        .select('id, full_name, email, created_at')
        .order('created_at', { ascending: false });

      if (error) {
        setStatus('Error loading users: ' + error.message);
        tableWrap.innerHTML = '';
        return;
      }

      if (!data || data.length === 0) {
        setStatus('No users yet.');
        tableWrap.innerHTML = '<p>No rows found.</p>';
        return;
      }

      setStatus(`Loaded ${data.length} user(s).`);
      const rows = data.map(u => `
        <tr>
          <td>${u.id}</td>
          <td>${escapeHtml(u.full_name)}</td>
          <td>${escapeHtml(u.email)}</td>
          <td>${new Date(u.created_at).toLocaleString()}</td>
        </tr>
      `).join('');

      tableWrap.innerHTML = `
        <table>
          <thead><tr><th>ID</th><th>Name</th><th>Email</th><th>Created At</th></tr></thead>
          <tbody>${rows}</tbody>
        </table>
      `;
    }

    function escapeHtml(s) {
      if (s == null) return '';
      return String(s).replace(/[&<>"'`=\/]/g, c => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#47;','`':'&#96;','=':'&#61;'
      }[c]));
    }

    document.getElementById('refreshBtn').addEventListener('click', loadUsers);

    function exportCSV() {
      supabase.from('users').select('id, full_name, email, created_at').then(({ data, error }) => {
        if (error || !data) { alert('Export failed: ' + (error?.message || 'no data')); return; }
        const headers = ['id','full_name','email','created_at'];
        const rows = data.map(r => headers.map(h => `"${String(r[h] ?? '').replace(/"/g,'""')}"`).join(','));
        const csv = [headers.join(','), ...rows].join('\n');
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'users.csv';
        document.body.appendChild(a); a.click(); a.remove();
        URL.revokeObjectURL(url);
      });
    }

    document.getElementById('exportBtn').addEventListener('click', exportCSV);

    // initial load
    loadUsers();
  </script>
</body>
</html>
